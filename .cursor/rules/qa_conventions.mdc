---
alwaysApply: true
---
# QA Automation Conventions

## –ü—Ä–∏–Ω—Ü–∏–ø—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç–∏—Ä—É–π —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω–æ–µ
- ‚úÖ **–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É** - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- ‚úÖ **–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ—Ç–æ–∫–∏** - —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ **Edge cases** - –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
- ‚ùå **–ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π** boilerplate (getters/setters, –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã dataclass)
- ‚ùå **–ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π** –≤–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (aiogram, OpenAI)
- ‚ùå **–ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π** –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –Ω–∞–ø—Ä—è–º—É—é

### KISS –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- –û–¥–∏–Ω —Ç–µ—Å—Ç = –æ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞
- –Ø–≤–Ω–æ–µ –ª—É—á—à–µ –Ω–µ—è–≤–Ω–æ–≥–æ
- –ü—Ä–æ—Å—Ç—ã–µ assertions –±–µ–∑ –º–∞–≥–∏–∏
- –ú–∏–Ω–∏–º—É–º –º–æ–∫–æ–≤ - —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### DRY –¥–ª—è —Ç–µ—Å—Ç–æ–≤
- –û–±—â–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã –≤ `conftest.py`
- –§–∞–±—Ä–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

### Naming Convention
```python
# –§–∞–π–ª—ã: test_<module_name>.py
tests/test_conversation.py
tests/test_user.py

# –§—É–Ω–∫—Ü–∏–∏: test_<what>_<condition>_<expected>
def test_add_message_success():
def test_add_message_exceeds_limit_raises_error():
def test_get_user_not_found_returns_none():
```

### Arrange-Act-Assert
```python
def test_conversation_add_message():
    # Arrange - –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞
    conversation = Conversation(chat_id=123)

    # Act - –¥–µ–π—Å—Ç–≤–∏–µ
    conversation.add_message("user", "Hello")

    # Assert - –ø—Ä–æ–≤–µ—Ä–∫–∞
    assert len(conversation.messages) == 1
    assert conversation.messages[0]["role"] == "user"
```

---

## TDD Workflow

### Red-Green-Refactor
1. **Red** - –ø–∏—à–∏ —Ç–µ—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–∞–¥–∞–µ—Ç
2. **Green** - –Ω–∞–ø–∏—à–∏ –º–∏–Ω–∏–º—É–º –∫–æ–¥–∞ –¥–ª—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
3. **Refactor** - —É–ª—É—á—à–∏ –∫–æ–¥, —Ç–µ—Å—Ç—ã –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å

### –¶–∏–∫–ª TDD
```bash
# 1. –ù–∞–ø–∏—à–∏ —Ç–µ—Å—Ç
def test_rate_limit_blocks_fast_requests():
    # Test code...

# 2. –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç - –¥–æ–ª–∂–µ–Ω —É–ø–∞—Å—Ç—å
make test

# 3. –†–µ–∞–ª–∏–∑—É–π –º–∏–Ω–∏–º—É–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
# ... –∫–æ–¥ ...

# 4. –ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç - –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏
make test

# 5. –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
# 6. –ü–æ–≤—Ç–æ—Ä–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π —Ñ–∏—á–∏
```

### –ö–æ–≥–¥–∞ –ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã
- **–ü–µ—Ä–µ–¥** —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –Ω–æ–≤–æ–π —Ñ–∏—á–∏ (TDD)
- **–ü–æ—Å–ª–µ** –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –±–∞–≥–∞ (regression test)
- **–ù–∏–∫–æ–≥–¥–∞** –¥–ª—è —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–æ–¥–∞ –±–µ–∑ –±–∞–≥–æ–≤

---

## –¢–∏–ø—ã —Ç–µ—Å—Ç–æ–≤

### Unit Tests (–æ—Å–Ω–æ–≤–Ω–æ–µ)
- –¢–µ—Å—Ç–∏—Ä—É—é—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å/—Ñ—É–Ω–∫—Ü–∏—é
- –ú–æ–∫–∞—é—Ç –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Protocol)
- –ë—ã—Å—Ç—Ä—ã–µ (< 1 sec –Ω–∞ —Ç–µ—Å—Ç)

```python
def test_user_is_active_true():
    """Unit: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = User(chat_id=123, username="test", first_name="Test")
    assert user.is_active is True
```

### Integration Tests (–º–∏–Ω–∏–º—É–º)
- –¢–µ—Å—Ç–∏—Ä—É—é—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –¢–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö flow
- –ú–æ–∫–∞—é—Ç —Ç–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω–∏–µ API

```python
@pytest.mark.asyncio
async def test_message_flow_with_llm():
    """Integration: –ø–æ–ª–Ω—ã–π flow –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    # Mock —Ç–æ–ª—å–∫–æ LLM API
    with patch('llm.client.LLMClient') as mock_llm:
        mock_llm.return_value.send_message.return_value = "Response"
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ handler + storage + conversation
        ...
```

### E2E Tests (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –¢–æ–ª—å–∫–æ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö user journeys
- –î–æ—Ä–æ–≥–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫–µ - –∏–∑–±–µ–≥–∞–π

---

## Fixtures –∏ Mocks

### Fixtures (conftest.py)
```python
# tests/conftest.py
import pytest
from src.user import User
from src.conversation import Conversation

@pytest.fixture
def sample_user() -> User:
    """–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    return User(chat_id=123, username="test_user", first_name="Test")

@pytest.fixture
def sample_conversation() -> Conversation:
    """–ü—É—Å—Ç–æ–π –¥–∏–∞–ª–æ–≥ –¥–ª—è —Ç–µ—Å—Ç–æ–≤"""
    return Conversation(chat_id=123)

# ‚ùå –ù–µ —Å–æ–∑–¥–∞–≤–∞–π fixture –¥–ª—è –∫–∞–∂–¥–æ–≥–æ edge case
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è –≤–º–µ—Å—Ç–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏—è
@pytest.mark.parametrize("text,expected", [
    ("", False),           # –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
    ("   ", False),        # —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª—ã
    ("Hello", True),       # –≤–∞–ª–∏–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
])
def test_validate_message(text: str, expected: bool):
    assert validate_message(text) == expected

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
def test_validate_message_empty():
    assert validate_message("") is False
def test_validate_message_spaces():
    assert validate_message("   ") is False
def test_validate_message_valid():
    assert validate_message("Hello") is True
```

### Mock —Ç–æ–ª—å–∫–æ –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - –º–æ–∫ –≤–Ω–µ—à–Ω–µ–≥–æ API
@pytest.fixture
def mock_llm_client():
    with patch('llm.client.LLMClient') as mock:
        mock.return_value.send_message.return_value = "Mocked response"
        yield mock.return_value

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –º–æ–∫ —Å–≤–æ–µ–≥–æ –∫–æ–¥–∞
@pytest.fixture
def mock_conversation():  # –ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∞–ª—å–Ω—ã–π Conversation!
    mock = MagicMock()
    mock.add_message.return_value = None
    return mock
```

---

## Assertions

### –ü—Ä–æ—Å—Ç—ã–µ –∏ —è–≤–Ω—ã–µ
```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
assert user.chat_id == 123
assert len(messages) == 2
assert result is None
assert "error" in response

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
assert all([msg["role"] in ["user", "assistant"] for msg in messages])  # –£–ø—Ä–æ—Å—Ç–∏!
```

### –ü—Ä–æ–≤–µ—Ä—è–π –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –Ω–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é
```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
def test_add_message_stores_correctly():
    conversation.add_message("user", "Hello")
    assert conversation.get_messages()[0]["content"] == "Hello"

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
def test_add_message_appends_to_list():
    conversation.add_message("user", "Hello")
    assert len(conversation._messages) == 1  # –ü—Ä–∏–≤–∞—Ç–Ω–∞—è –¥–µ—Ç–∞–ª—å!
```

---

## Async —Ç–µ—Å—Ç—ã

```python
import pytest

# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ - pytest-asyncio
@pytest.mark.asyncio
async def test_async_handler():
    result = await some_async_function()
    assert result == expected

# Mock async —Ñ—É–Ω–∫—Ü–∏–π
@pytest.fixture
def mock_async_client():
    with patch('src.client.AsyncClient') as mock:
        mock.return_value.request = AsyncMock(return_value="response")
        yield mock.return_value
```

---

## –ß—Ç–æ –ù–ï —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### Boilerplate –∫–æ–¥
```python
# ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π dataclass –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã
@dataclass
class User:
    chat_id: int
    username: str

# –ù–ï –ù–£–ñ–ï–ù —Ç–µ—Å—Ç:
def test_user_creation():
    user = User(chat_id=123, username="test")
    assert user.chat_id == 123  # –≠—Ç–æ –¥–µ–ª–∞–µ—Ç dataclass!
```

### –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
```python
# ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π aiogram
def test_message_answer():
    # –ù–µ –ø—Ä–æ–≤–µ—Ä—è–π, —á—Ç–æ message.answer() –≤—ã–∑—ã–≤–∞–µ—Ç Telegram API
    # aiogram —É–∂–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω!

# ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π OpenAI SDK
def test_openai_chat_completion():
    # OpenAI SDK –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –µ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
```

### –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã
```python
# ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã –Ω–∞–ø—Ä—è–º—É—é
def test_cleanup_old_conversations():  # –ù–ï –ù–£–ñ–ï–ù!
    storage._cleanup_old()  # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Ç–æ–¥!

# ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–π —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–π API
def test_storage_removes_expired():
    storage.add(conversation)
    time.sleep(TTL + 1)
    assert storage.get(chat_id) is None  # _cleanup –≤—ã–∑–≤–∞–Ω –≤–Ω—É—Ç—Ä–∏
```

### –¢—Ä–∏–≤–∏–∞–ª—å–Ω—ã–π –∫–æ–¥
```python
# ‚ùå –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π –≥–µ—Ç—Ç–µ—Ä—ã
def test_get_chat_id():
    user = User(chat_id=123, ...)
    assert user.chat_id == 123  # –û—á–µ–≤–∏–¥–Ω–æ!
```

---

## Coverage

### –¶–µ–ª–µ–≤–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ
- **–ú–∏–Ω–∏–º—É–º**: 80% –æ–±—â–µ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è
- **–¶–µ–ª—å**: 90%+ –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- **–ò–≥–Ω–æ—Ä–∏—Ä—É–π**:
  - `main.py` (—Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞)
  - `__init__.py`
  - Type stubs (Protocol)

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫—Ä—ã—Ç–∏—è
```bash
make test-cov       # –ó–∞–ø—É—Å–∫ —Å coverage
coverage report     # –û—Ç—á–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏
coverage html       # HTML –æ—Ç—á–µ—Ç –≤ htmlcov/
```

### Coverage –Ω–µ —Ä–∞–≤–Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ
- ‚úÖ 80% —Å —Ö–æ—Ä–æ—à–∏–º–∏ —Ç–µ—Å—Ç–∞–º–∏ > 100% —Å –ø–ª–æ—Ö–∏–º–∏
- ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–π –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—É—Ç–∏, –Ω–µ –≥–æ–Ω–∏—Å—å –∑–∞ 100%
- ‚ùå –ù–µ –ø–∏—à–∏ —Ç–µ—Å—Ç—ã —Ç–æ–ª—å–∫–æ —Ä–∞–¥–∏ coverage

---

## –ö–æ–º–∞–Ω–¥—ã

```bash
make test           # –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
make test-cov       # –¢–µ—Å—Ç—ã + coverage
make test-watch     # –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
pytest tests/test_user.py -v  # –û–¥–∏–Ω —Ñ–∞–π–ª
pytest tests/ -k "conversation"  # –ü–æ –∏–º–µ–Ω–∏
pytest tests/ -x    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
```

---

## Checklist –¥–ª—è —Ç–µ—Å—Ç–∞

- [ ] –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç **–≤–∞–∂–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**, –Ω–µ boilerplate?
- [ ] –ò–º—è —Ç–µ—Å—Ç–∞ —è—Å–Ω–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç **—á—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è**?
- [ ] –¢–µ—Å—Ç **–Ω–µ–∑–∞–≤–∏—Å–∏–º** –æ—Ç –¥—Ä—É–≥–∏—Ö —Ç–µ—Å—Ç–æ–≤?
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–º–∏–Ω–∏–º—É–º –º–æ–∫–æ–≤**?
- [ ] Assertions **–ø—Ä–æ—Å—Ç—ã–µ –∏ —è–≤–Ω—ã–µ**?
- [ ] –¢–µ—Å—Ç **–±—ã—Å—Ç—Ä—ã–π** (< 1 sec)?
- [ ] –¢–µ—Å—Ç **—á–∏—Ç–∞–µ–º—ã–π** –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤?

---

## –ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö —Ç–µ—Å—Ç–æ–≤

### Unit Test
```python
def test_conversation_get_messages_formats_correctly(sample_conversation):
    """Unit: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è LLM API"""
    sample_conversation.add_message("user", "Hello")
    sample_conversation.add_message("assistant", "Hi")

    messages = sample_conversation.get_messages()

    assert len(messages) == 2
    assert messages[0] == {"role": "user", "content": "Hello"}
    assert messages[1] == {"role": "assistant", "content": "Hi"}
```

### Edge Case Test
```python
def test_rate_limit_allows_after_delay(sample_user):
    """Edge: rate limit —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –∑–∞–¥–µ—Ä–∂–∫–∏"""
    middleware = RateLimitMiddleware(rate_limit=2)

    middleware.check(sample_user.chat_id)  # –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
    time.sleep(2.1)  # –ñ–¥–µ–º > rate_limit

    # –î–æ–ª–∂–µ–Ω —Ä–∞–∑—Ä–µ—à–∏—Ç—å
    assert middleware.check(sample_user.chat_id) is True
```

### Integration Test
```python
@pytest.mark.asyncio
async def test_full_message_flow(mock_llm_client):
    """Integration: –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    # Arrange
    deps = create_test_dependencies(llm_client=mock_llm_client)
    message = create_test_message(text="Hello bot")

    # Act
    await message_handler(message, deps=deps)

    # Assert
    mock_llm_client.send_message.assert_called_once()
    assert deps.conversation_storage.get(123) is not None
```

---

## –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Ç–µ—Å—Ç–æ–≤

### –ü—Ä–∏–∑–Ω–∞–∫–∏ –ø–ª–æ—Ö–æ–≥–æ —Ç–µ—Å—Ç–∞
- üî¥ –°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (> 20 —Å—Ç—Ä–æ–∫) ‚Üí –†–∞–∑–±–µ–π –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ
- üî¥ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—â–µ–π ‚Üí –û–¥–∏–Ω —Ç–µ—Å—Ç = –æ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞
- üî¥ –ù–µ—è—Å–Ω–æ–µ –∏–º—è ‚Üí –ü–µ—Ä–µ–∏–º–µ–Ω—É–π
- üî¥ –¢—Ä–µ–±—É–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ ‚Üí –£–ø—Ä–æ—Å—Ç–∏
- üî¥ –ú–Ω–æ–≥–æ –º–æ–∫–æ–≤ ‚Üí –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

### –ö–æ–≥–¥–∞ —É–¥–∞–ª—è—Ç—å —Ç–µ—Å—Ç—ã
- ‚úÖ –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É–¥–∞–ª–µ–Ω–Ω—É—é —Ñ–∏—á—É
- ‚úÖ –¢–µ—Å—Ç –¥—É–±–ª–∏—Ä—É–µ—Ç –¥—Ä—É–≥–æ–π —Ç–µ—Å—Ç
- ‚úÖ –¢–µ—Å—Ç –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ü–µ–Ω–Ω–æ—Å—Ç–∏ (trivial assertion)
- ‚úÖ –¢–µ—Å—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–∞–¥–∞–µ—Ç –±–µ–∑ –ø—Ä–∏—á–∏–Ω—ã (flaky test)

**–ù–µ –±–æ–π—Å—è —É–¥–∞–ª—è—Ç—å –ø–ª–æ—Ö–∏–µ —Ç–µ—Å—Ç—ã** - –∫–∞—á–µ—Å—Ç–≤–æ –≤–∞–∂–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞!

---

## –†–µ—Ñ–µ—Ä–µ–Ω—Å

- –û—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è: [conventions.mdc](./conventions.mdc)
- –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏: [workflow.mdc](./workflow.mdc)
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: [vision.md](../../docs/vision.md)
