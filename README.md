# 🤖 Systech AIDD Test - Telegram LLM Assistant Bot

> Production-ready Telegram-бот с интеграцией LLM через OpenRouter API

Telegram-бот на Python, который работает как AI-ассистент с использованием различных LLM моделей через OpenRouter. Проект следует принципам **KISS** (Keep It Simple, Stupid) и **SOLID**, создан с фокусом на простоту, надежность, безопасность и качество кода.

**Статус:** ✅ Production Ready (v2.0) | **Покрытие тестами:** 70.17% | **Тестов:** 89 | **Качество:** 8.7/10

---

## ✨ Основные возможности

- 💬 **Контекстные диалоги** - бот помнит историю разговора (до 10 последних сообщений)
- 🧠 **Интеграция с LLM** - использование различных моделей через OpenRouter API
- 🔄 **Управление контекстом** - команда `/clear` для начала нового диалога
- 🔒 **Безопасность** - rate limiting, валидация входных данных, скрытие внутренних ошибок
- ⚡ **Управление памятью** - LRU cache + TTL для автоматической очистки старых данных
- 🏗️ **Чистая архитектура** - Dependency Injection, Protocol interfaces, SOLID принципы
- 📊 **Система метрик** - отслеживание запросов, ошибок, токенов и стоимости
- 🔄 **Надежность** - retry logic для сетевых сбоев, graceful shutdown
- 📝 **Полное логирование** - все действия записываются в файл с автоматической ротацией
- ⚙️ **Гибкая настройка** - конфигурация через переменные окружения
- ✅ **Высокое покрытие тестами** - 89 тестов, 70.17% покрытия кода
- 🚀 **Production Ready** - готов к развертыванию в продакшене

---

## 🛠️ Технологический стек

| Компонент | Технология | Назначение |
|-----------|-----------|-----------|
| **Язык** | Python 3.11+ | Основной язык разработки |
| **Bot Framework** | aiogram 3.x | Работа с Telegram Bot API |
| **LLM Client** | openai | Взаимодействие с OpenRouter API |
| **Package Manager** | uv | Управление зависимостями |
| **Testing** | pytest + pytest-asyncio + pytest-cov | Автоматическое тестирование |
| **Linting** | ruff | Быстрый линтер (E, W, F, I, N, UP, B, C4, SIM) |
| **Type Checking** | mypy | Статическая проверка типов (strict mode) |
| **Code Style** | black | Форматирование кода |
| **Config** | python-dotenv | Загрузка переменных окружения |
| **Storage** | In-memory (LRU+TTL) | Хранение данных с управлением памятью |

### Архитектура

```
┌─────────────────┐
│  Telegram User  │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────┐
│       Bot (aiogram)             │
│  ┌──────────────────────────┐   │
│  │   Middleware Layer       │   │
│  │  • Rate Limiting         │   │
│  │  • Dependency Injection  │   │
│  └──────────────────────────┘   │
└────────┬────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│     Handlers + Validators       │
│  (обработка команд и валидация) │
└────────┬────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│    BotDependencies (DI)         │
│  ┌─────────────────────────┐    │
│  │ • UserStorage (LRU+TTL) │    │
│  │ • ConvStorage (LRU+TTL) │    │
│  │ • LLM Client (retry)    │    │
│  │ • Config                │    │
│  │ • Metrics               │    │
│  └─────────────────────────┘    │
└────────┬────────────────────────┘
         │
         ▼
┌─────────────────┐
│   LLM Client    │ ◄── запросы к OpenRouter API
└─────────────────┘
```

---

## 📦 Установка и запуск

### Шаг 1: Установка uv (если еще не установлен)

**Windows:**
```powershell
powershell -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**Linux/macOS:**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

### Шаг 2: Клонирование репозитория

```bash
git clone <repository-url>
cd systech-aidd-test
```

### Шаг 3: Установка зависимостей

```bash
make install
```

Или вручную:
```bash
uv sync --all-extras
```

### Шаг 4: Настройка переменных окружения

Создайте файл `.env` в корне проекта:

```bash
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here

# OpenRouter API
OPENROUTER_API_KEY=your_openrouter_api_key_here
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
OPENROUTER_MODEL=gpt-oss-20b

# Bot Settings
DEFAULT_SYSTEM_PROMPT=Ты полезный AI-ассистент
MAX_CONTEXT_MESSAGES=10

# Storage Settings (опционально)
MAX_STORAGE_SIZE=1000
STORAGE_TTL_HOURS=24

# Logging (опционально)
LOG_FILE=logs/bot.log
LOG_LEVEL=INFO
```

### Шаг 5: Получение токенов

#### Telegram Bot Token:
1. Найдите [@BotFather](https://t.me/botfather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен в `.env`

#### OpenRouter API Key:
1. Зарегистрируйтесь на [OpenRouter](https://openrouter.ai/)
2. Получите API ключ в личном кабинете
3. Добавьте его в `.env`

### Шаг 6: Запуск бота

```bash
make run
```

Или напрямую:
```bash
uv run python -m src.main
```

Бот запущен! Отправьте ему команду `/start` в Telegram.

---

## 🎮 Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Инициализация бота и приветствие |
| `/clear` | Очистка истории диалога (начать заново) |
| *Любой текст* | Отправка сообщения AI-ассистенту с учетом контекста |

---

## 📸 Демонстрация работы

<!-- Добавьте сюда скриншот или GIF с работой бота -->

> 💡 **Совет:** Сделайте скриншот диалога с ботом или запишите короткое GIF, показывающее основные функции, и добавьте сюда.

**Пример использования:**
```
Пользователь: /start
Бот: 👋 Привет! Я AI-ассистент...

Пользователь: Расскажи про Python
Бот: Python - это высокоуровневый...

Пользователь: А какие у него преимущества?
Бот: (помнит контекст и отвечает про Python)

Пользователь: /clear
Бот: 🧹 История диалога очищена...
```

---

## 🧪 Разработка

### Команды разработки

```bash
# Запуск тестов
make test

# Запуск тестов с отчетом о покрытии
make test-cov

# Форматирование кода
make format

# Проверка качества кода (ruff)
make lint

# Проверка типов (mypy)
make type-check

# Все проверки (lint + type-check + test)
make check

# Очистка кеша и временных файлов
make clean

# Справка по командам
make help
```

### 🔍 Code Quality

Проект использует современные инструменты контроля качества кода:

| Инструмент | Назначение | Команда |
|-----------|------------|---------|
| **ruff** | Быстрый линтер (E, W, F, I, N, UP, B, C4, SIM) | `make lint` |
| **mypy** | Статическая проверка типов (strict mode) | `make type-check` |
| **black** | Форматирование кода | `make format` |
| **pytest** | Запуск тестов | `make test` |
| **pytest-cov** | Покрытие кода тестами (≥30%) | `make test-cov` |

**Перед коммитом всегда запускайте:**
```bash
make check
```
Эта команда выполнит все проверки: lint, type-check и test.

### Структура проекта

```
systech-aidd-test/
├── src/                    # Исходный код бота
│   ├── main.py            # Точка входа приложения
│   ├── bot.py             # Класс бота (aiogram)
│   ├── config.py          # Управление конфигурацией
│   ├── logger.py          # Настройка логирования
│   ├── user.py            # Управление пользователями (LRU+TTL)
│   ├── conversation.py    # Управление диалогами (LRU+TTL)
│   ├── protocols.py       # Protocol интерфейсы (DI)
│   ├── dependencies.py    # Контейнер зависимостей (DI)
│   ├── validators.py      # Валидация входных данных
│   ├── metrics.py         # Система метрик
│   ├── handlers/          # Обработчики команд и сообщений
│   │   └── handlers.py
│   └── middlewares/       # Middlewares для aiogram
│       ├── __init__.py
│       ├── rate_limit.py           # Rate limiting
│       └── dependency_injection.py  # Dependency Injection
├── llm/                   # LLM клиент
│   └── client.py         # Класс для работы с OpenRouter API (retry logic)
├── tests/                 # Тесты (pytest) - 89 тестов, 70.17% покрытия
│   ├── test_config.py         # Тесты конфигурации (18 тестов)
│   ├── test_user.py           # Тесты пользователей (13 тестов)
│   ├── test_conversation.py   # Тесты диалогов (13 тестов)
│   ├── test_integration.py    # Интеграционные тесты (8 тестов)
│   ├── test_rate_limit.py     # Тесты rate limiting (7 тестов)
│   ├── test_dependencies.py   # Тесты DI (7 тестов)
│   ├── test_metrics.py        # Тесты метрик (16 тестов)
│   └── test_validators.py     # Тесты валидации (7 тестов)
├── docs/                  # Документация проекта
│   ├── vision.md              # Техническое видение
│   ├── tasklist.md            # План разработки (итерации)
│   ├── tasklist_tech_debt.md  # План устранения техдолга (завершен)
│   ├── code_review_summary.md # Результаты code review
│   └── idea.md                # Первоначальная идея
├── logs/                  # Логи бота (создается автоматически)
│   └── bot.log           # Файл логов с ротацией (10MB, 5 файлов)
├── .env                   # Переменные окружения (не в git)
├── .env.example          # Пример конфигурации
├── pyproject.toml        # Конфигурация проекта и зависимости
├── uv.lock               # Lock-файл зависимостей
├── Makefile              # Команды для разработки
├── presentation.md       # Презентация выполненной работы
└── README.md             # Этот файл
```

### Принципы разработки

Проект следует строгим принципам разработки:

- ✅ **KISS** (Keep It Simple, Stupid) - максимальная простота решений
- ✅ **SOLID** - применение принципов объектно-ориентированного проектирования
  - **Dependency Inversion**: Protocol interfaces вместо конкретных классов
  - **Single Responsibility**: каждый класс отвечает за одну задачу
  - **Open/Closed**: расширяемость через middleware и DI
- ✅ **1 класс = 1 файл** - строгое правило для читаемости
- ✅ **Dependency Injection** - слабая связанность компонентов
- ✅ **Минимум зависимостей** - только необходимые библиотеки
- ✅ **Явное лучше неявного** - понятный и читаемый код
- ✅ **Type Safety** - строгая типизация (mypy strict mode)
- ✅ **Без оверинжиниринга** - никаких избыточных абстракций

Подробнее см. [docs/vision.md](docs/vision.md)

---

## 📊 Статус проекта

### Реализовано (v1.0)
- ✅ Базовая инфраструктура проекта
- ✅ Telegram бот с aiogram
- ✅ Интеграция с LLM через OpenRouter
- ✅ Контекстные диалоги с ограничением истории
- ✅ Команды /start и /clear
- ✅ Полное логирование с ротацией
- ✅ Валидация конфигурации
- ✅ Комплексное тестирование (89 тестов, 70.17% покрытия)

### Реализовано (v2.0 - Production Ready)
**Дата завершения:** 11.10.2025

#### 🔒 Security & Validation
- ✅ Rate limiting (1 сообщение в 2 секунды)
- ✅ Валидация входных данных (макс 4000 символов)
- ✅ Скрытие внутренних ошибок от пользователей
- ✅ Graceful error handling

#### 🏗️ Architecture Refactoring
- ✅ Dependency Injection (DI) архитектура
- ✅ Protocol-based interfaces (SOLID)
- ✅ Убраны все глобальные переменные
- ✅ Retry logic для Telegram API (3 попытки)

#### ⚡ Memory & Performance
- ✅ LRU cache для UserStorage (макс 1000 записей)
- ✅ LRU cache для ConversationStorage (макс 1000 записей)
- ✅ TTL механизм (автоочистка через 24 часа)
- ✅ Защита от утечек памяти

#### 🔧 Code Quality Tools
- ✅ Ruff линтер (исправлено 294 ошибки)
- ✅ Mypy типизация (исправлено 60 ошибок)
- ✅ Black форматирование
- ✅ Автоматизация проверок (`make check`)

#### 🧪 Testing & Monitoring
- ✅ Интеграционные тесты (8 тестов)
- ✅ Unit тесты для middlewares (14 тестов)
- ✅ Система метрик (BotMetrics)
- ✅ Покрытие кода 70.17% (+37.48%)

**Результаты:**
- 🎯 Production Ready: 4/10 → 8/10 (+100%)
- 📊 Тесты: 43 → 89 (+107%)
- 🛡️ Security: 5/10 → 9/10 (+80%)
- 🏗️ Architecture: 7/10 → 9/10 (+29%)

См. детали в [docs/tasklist_tech_debt.md](docs/tasklist_tech_debt.md) и [presentation.md](presentation.md)

### Планируется (будущие расширения)
- ⏳ Команда /role - переключение ролей AI
- ⏳ Команда /stats - статистика работы бота
- ⏳ Настройка параметров LLM (температура, max_tokens)
- ⏳ Экспорт истории диалога в файл
- ⏳ Сохранение диалогов в SQLite
- ⏳ Поддержка голосовых сообщений
- ⏳ Потоковая передача ответов (streaming)

См. полный план в [docs/tasklist.md](docs/tasklist.md)

---

## 🔐 Безопасность и производительность

### Безопасность
- **Rate Limiting**: Защита от спама и DDoS атак (1 сообщение/2 сек)
- **Валидация входных данных**: Проверка длины и содержимого сообщений
- **Скрытие ошибок**: Внутренние детали не показываются пользователям
- **Graceful shutdown**: Корректное завершение работы по сигналу

### Производительность
- **LRU Cache**: Автоматическое удаление старых записей при достижении лимита
- **TTL механизм**: Автоочистка данных старше 24 часов
- **Управление памятью**: Ограничение размера storage (1000 записей по умолчанию)
- **Retry logic**: Автоматические повторные попытки при сетевых сбоях

### Мониторинг
- **Система метрик**: Отслеживание запросов, ошибок, токенов и стоимости
- **Детальное логирование**: Все важные события записываются в лог
- **Error tracking**: Полные traceback'и для отладки

---

## 📝 Лицензия

MIT License - свободное использование и модификация.

---

## 👨‍💻 Автор

**Systech AIDD Test Project**

Создано для демонстрации навыков разработки Telegram-ботов с интеграцией LLM.

---

## 🤝 Вклад в проект

Проект открыт для улучшений! Если вы хотите добавить новые функции или исправить ошибки:

1. Ознакомьтесь с [docs/vision.md](docs/vision.md) для понимания архитектуры
2. Изучите [docs/tasklist.md](docs/tasklist.md) для планирования
3. Следуйте принципам KISS и существующему стилю кода
4. Добавьте тесты для нового функционала

---

## 🔗 Полезные ссылки

- [Aiogram Documentation](https://docs.aiogram.dev/)
- [OpenRouter API](https://openrouter.ai/docs)
- [Python Telegram Bot Guide](https://core.telegram.org/bots/api)
- [UV Package Manager](https://github.com/astral-sh/uv)

---

**Вопросы?** Создайте issue в репозитории или обратитесь к документации в папке `docs/`.
