# Техническое видение проекта: LLM-ассистент в виде Telegram-бота

## Технологии

### Основное
- **Python 3.11+** - основной язык
- **uv** - управление зависимостями и виртуальным окружением
- **aiogram 3.x** - работа с Telegram Bot API (polling)
- **openai** - клиент для работы с LLM через Openrouter
- **python-dotenv** - загрузка переменных окружения

### Инфраструктура
- **make** - автоматизация задач (запуск, форматирование)

### Разработка
- **pytest** - тестирование
- **black** - форматирование кода

### Хранение данных
- **In-memory** - хранение данных в классах Python (словари, списки)

### Логирование
- **Текстовый файл** - простое логирование в файл

## Принцип разработки

### Основные принципы
- **KISS (Keep It Simple, Stupid)** - максимальная простота решения
- **ООП** - объектно-ориентированное программирование
- **1 класс = 1 файл** - строгое соблюдение для читаемости
- **Минимум зависимостей** - только необходимые библиотеки

### Подход к разработке
- **Итеративная разработка** - сначала работающий MVP, потом улучшения
- **Явное лучше неявного** - понятный и читаемый код
- **Без оверинжиниринга** - никаких избыточных абстракций и паттернов

## Структура проекта

```
systech-aidd-test/
├── src/
│   ├── __init__.py
│   ├── main.py              # Точка входа, запуск бота
│   ├── bot.py               # Класс бота (aiogram)
│   ├── config.py            # Класс конфигурации
│   ├── conversation.py      # Класс для управления диалогами
│   ├── user.py              # Класс для управления пользователями
│   └── handlers/
│       ├── __init__.py
│       └── handlers.py      # Обработчики сообщений и команд
├── llm/
│   ├── __init__.py
│   └── client.py            # Класс для работы с LLM
├── tests/
│   ├── __init__.py
│   └── test_bot.py          # Базовые тесты
├── logs/                    # Папка для логов
├── .env.example             # Пример переменных окружения
├── .env                     # Переменные окружения (не в git)
├── .gitignore
├── pyproject.toml           # Конфигурация uv
├── Makefile                 # Команды для запуска
└── README.md
```

## Архитектура проекта

### Схема взаимодействия компонентов

```
┌─────────────────┐
│  Telegram User  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Bot (aiogram) │ ◄── handlers.py (обработка команд и сообщений)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Conversation   │ ◄── управление диалогами и контекстом
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   LLM Client    │ ◄── запросы к OpenRouter API
└─────────────────┘
```

### Описание компонентов
- **Bot** - инициализация aiogram, polling, маршрутизация
- **Handlers** - обработка команд (/start, /clear) и текстовых сообщений
- **Conversation** - хранение истории диалога, управление контекстом
- **User** - хранение данных пользователя (chat_id, настройки)
- **LLM Client** - отправка запросов к LLM, получение ответов
- **Config** - загрузка и хранение конфигурации из .env

## Модель данных

### User (класс пользователя)
```python
class User:
    chat_id: int             # ID чата в Telegram
    username: str            # Username
    first_name: str          # Имя
    current_role: str        # Текущая роль (системный промпт)
```

### Conversation (класс диалога)
```python
class Conversation:
    chat_id: int             # ID чата
    messages: list           # История сообщений [{role, content}]
```

### Message (структура сообщения)
```python
{
    "role": "user|assistant|system",
    "content": "текст сообщения"
}
```

### Хранение данных
- **UserStorage** - словарь `{chat_id: User}`
- **ConversationStorage** - словарь `{chat_id: Conversation}`

## Работа с LLM

### Конфигурация
```python
OPENROUTER_API_KEY = "..."
OPENROUTER_BASE_URL = "https://openrouter.ai/api/v1"
MODEL = "openai/gpt-3.5-turbo"  # или другая модель
```

### Процесс работы
1. Получение сообщения от пользователя
2. Формирование контекста из истории диалога
3. Добавление системного промпта (роль)
4. Отправка запроса к OpenRouter API через openai client
5. Получение ответа от LLM
6. Сохранение в историю диалога
7. Отправка ответа пользователю

### Формат запроса к LLM
```python
messages = [
    {"role": "system", "content": system_prompt},
    {"role": "user", "content": "..."},
    {"role": "assistant", "content": "..."},
    ...
]
```

### Управление контекстом
- Максимум последних **10 сообщений** в контексте
- При превышении - удаление самых старых сообщений

## Сценарии работы

### 1. Первый запуск бота
```
1. Пользователь отправляет /start
2. Создается User с данными из Telegram
3. Создается Conversation для пользователя
4. Устанавливается роль по умолчанию
5. Отправляется приветственное сообщение
```

### 2. Обычный диалог
```
1. Пользователь отправляет текстовое сообщение
2. Проверяется наличие ответа в контексте диалога
3. Если ответ найден в контексте - используется он
4. Если не найден - сообщение добавляется в историю
5. Формируется контекст (системный промпт + история)
6. Отправляется запрос к LLM
7. Получается ответ от LLM
8. Ответ добавляется в историю диалога
9. Ответ отправляется пользователю
```

### 3. Команды бота
- **/start** - инициализация пользователя, приветствие
- **/clear** - очистка истории диалога

## Подход к конфигурированию

### Структура .env файла
```bash
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_telegram_bot_token

# OpenRouter API
OPENROUTER_API_KEY=your_openrouter_api_key
OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
OPENROUTER_MODEL=openai/gpt-3.5-turbo

# Bot Settings
DEFAULT_SYSTEM_PROMPT=Ты полезный AI-ассистент
MAX_CONTEXT_MESSAGES=10

# Logging
LOG_FILE=logs/bot.log
LOG_LEVEL=INFO
```

### Загрузка конфигурации
- Использование **python-dotenv** для загрузки переменных
- Все настройки загружаются в класс **Config**
- Валидация обязательных параметров при старте

## Подход к логгированию

### Уровни логирования
- **DEBUG** - детальная отладочная информация
- **INFO** - общая информация о работе бота
- **WARNING** - предупреждения
- **ERROR** - ошибки

### Что логируется
- Запуск и остановка бота
- Получение сообщений от пользователей
- Запросы к LLM API
- Ошибки при работе с API
- Выполнение команд

### Формат логов
```
[2024-10-10 12:30:45] INFO - Bot started
[2024-10-10 12:31:10] INFO - User 12345 sent message: "Привет"
[2024-10-10 12:31:12] INFO - LLM request sent for user 12345
[2024-10-10 12:31:15] INFO - LLM response received
[2024-10-10 12:31:15] ERROR - Failed to send message: Connection timeout
```

### Настройка
- Логи сохраняются в файл `logs/bot.log`
- Ротация файлов при достижении размера 10MB
- Хранение последних 5 файлов логов
